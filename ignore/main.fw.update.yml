---
- hosts: all
  connection: network_cli
  vars_files: vault.yml
  gather_facts: 'no'

  tasks:
    - name: Configure vyos-{{ vyos_hostname }}-1 system settings
      vyos_config:
        lines:
        - set service ssh port '22'
        - set system config-management commit-revisions '100'
        - set system conntrack modules ftp
        - set system conntrack modules h323
        - set system conntrack modules nfs
        - set system conntrack modules pptp
        - set system conntrack modules sip
        - set system conntrack modules sqlnet
        - set system conntrack modules tftp
        - set system console device ttyS0 speed '115200'
        - set system host-name '{{ vyos_hostname }}'
        - set system login user vyos authentication public-keys houndsolo@archlinux key 'AAAAB3NzaC1yc2EAAAADAQABAAAEAQCqiUCaNVQF7wLvWIiGB/olMnaKeElP4zLJndHwj0OIbBCpN4zzEXDOWoEdkGSzShlKlXzk/q+0Bi2KNyjqu+66UlnLAKOtw1t4L+iDXGP1P/27ah/azP+eDzjOuBXTtiO7gdjSGoma5jRLhyR5Le/OOYZKnvNWkzsNkaB0QdCKD56uYGuw06FIDSHsTHKzC0lu7Ma9Rjot5M3zW4zTDahqh5Uh9INhr7W1hMCkKbHmHUne0A9rVAkj+jd2IUqfH4amCHjB/zW3lfcAiLV4UOUaNh1LWr4g4qRGBdUTes7MgblYQw6JWxXzzM/4b2mbM7nFzHLr9LmkQcGC4JU2QTJc3kHL/YwsxzRPJcJXpPMmMj0ndSnJYNsEstax4NKtCDm/5MAOVGi8vaIrZ+Gkt8ESMpwvNH/NI8ODTblSxcPu92bAFkYGlc9/uOmmY1i5iATHp/juGt0+hj6jZJJ+4s2y+NFNv67jXrde/yAN9PW71MbKDYXBRh9eVT9RRcj0vp8jR3e8yKnHL8dHtzxoowd37zIa5iX4iJQ9OToAcnql4jEzOUQhzGaGng6FRDOgDzdSVu9dSGegVl2MhFmZABwrBHuNhIYuFQcN53AxAUEOGIq+cELh/1JsaQQy+rqg5pEYLw3NjMnH/ngIKXOG/HHpamM6ueYwhQ7jiR7VkHqjXbALGKKdgMovzdc/d7N79+8/PHZthzyMBtnNxxJtH4a5d+qEj6aFmKbJ+e5NGyt8tJXAAO/QIsXq5TIstrMqLAkbYbcGxBe8YWWcnmWE69nVzKoA5mSNq+2pX3Q+0fASbOMLROGBUaoqJISk9MoxOZ3xrvMxQ54dioYBbqSmak+GoJJ9eM6lGCcytrAqgTKk8CuJA+WZRI2xqnFThhuvj4mv1EGvZ5k/tKTkascwpxDus0sYZGQYt2uxPQ6oq7YQsWXfxjFlJszMP4/9FJp7OhF5K4e44ImEG6ie/wo16Ny0kZAhS2Mqt5+W8Cfvosbr9MjUmSWlnrBgoMTMggCx8JW5pMR2b+4V9DNX/5YQ4+DbmjeWnxHgDuXVaabxFg0TpAwYXtFrzNrEeBONQNW0yMStbShtnGkMnYjFnCWGd7pbmNdOTB/igrCUc5kkZS9kKKVCYcDVJoY7iwSxR2LXorjKnPR88du+gRXWcppJBWTg5mRq7GSX9xLKS04GqBNPL+82mKLXJXNyO/QWEOTjHHiq+CuJyg/r0eKRSGd6eOY/w76dHmhrQz2HdguDIAVTHVDKsLYU9wLzAyQbC019I2T1Vc6zCi7dwTU9fD3A4E2Oa2iFm97kpiksmUSwEEWpOcke49NBzBrmu8zeNYdGh33o4mlxp8UbdiLawODfm9rv'
        - set system login user vyos authentication public-keys houndsolo@archlinux type 'ssh-rsa'
        - set system login user vyos authentication public-keys houndsolo@msi key 'AAAAB3NzaC1yc2EAAAADAQABAAAEAQCuu5wm/71h2spb4HYRcdpG99SKDrYz+cEIdsZMErrEp0Oci7m8YpYWP0rWjCk+wiJf708ucZRhOBq0KyyaPMGveRlwVPV/47r1VnR4P3P6Bv342LPByXsePVlbGdhOHbkEiov7EtecGbhHZG8iGZ/a1SHJv39tU7gbaauzQVd8cZiGVV+enge7qCASldqBENArqrVy0LIErF2bbW2+Ivf89c87NGJbVjNHgylbvpvdXZb1wlUUAQtkKfGPZCt+Qgs9tjAvWuTYzvrjLO71Fgs6zniQ80Enx7G7wG9qKxBDYFftmNOFZLiIhGJ8bpswK5ubFBlloCnTPx3t/UYR39420hZO8YFsvFIvDspFiKM75KY1g017pf1M5ufpM29u322nhjduuf7L5QvAIbUDfgOMIDw5dxWHz/uay7wv8jjOcT0t734QSjspCgIPTnmkMNbwW36j7xMdrpL5d0g+HtXYaPsUjxxrAMG29p8VGRymXlLKgLergaeBnyi9qlV4nVnT5u1IJwIth5HpnnEfu6W3uYqxbz0R+qHhmZgy6y7iKWTvbheVuvl/kdMCMNEAv1OfH9OWSP8muDijuKLRHvfwPvnqjlGa05gc6prsLsJUicZM4aqBbJ7m4VYeM8RFWi7MCEEO66/I4BYB11FAALlvZKdt66xdEpkxBktfuPQSGrgJXbmVoC71uRm6329nUcf36JSmsMYMLj40vSyFPEyll3GRVxifVq24LpddGSgio0hEapntp/ZpktshOnj713NOC7JUCWG4YeUL6/KJUNxDBK51HeGUjmnaAMKybqeMeyvrF/tVGlHivxTwkWecazoq8a70KJbmE6MmT1KHqVmpUlW1eVJy9vGpERxNnmeoJ25xzXgfyp0fIfVpQWDsqGGxjPD0cgMESl27Ra2rlgMgYcmMOIl4qnz7fODKgYdBXFKnzel6Za7ISCnIALR1Ry6Qg9lCWOK/Xy6OvHTyew94KV+izwSRzHa3BA+o6NeRzxGQfI47B27Xm43gEM/pXnxnCACA1O2Lk7abd8gQmi4H8M5F59UwyuRyQSlEDbNnpdynwVsPvowYy8gjruNIv9cvsFBwrgWSWFJmB9LI6lOUSTjDk4nsDCU4El69TJiAuV5miniS+qrPOjNlh7CCYSdbQcgo8d6jOe0BFAH9NbRull7vv79BSPin+Gc7ppwsErbXPbBJrD4iumQ75eHuvDdtX3+kyLcHtlLAfHN4RmieCtF6cKMQHMkaFNBkEF3i+Fdebjk08CawP6Yvogm0z3Lqkrv/HSiqB/wEO0DiPyDzGgMNhHbJ8O1RcEQi/E/dfmeWtfTQwa+0tsNjxbSkxPeXUfo2Uk9k+TzMnD8I0tfN'
        - set system login user vyos authentication public-keys houndsolo@msi type 'ssh-rsa'
          #- set system name-server '10.2.0.4'
        - delete system name-server
        - set system ntp server time1.vyos.net
        - set system ntp server time2.vyos.net
        - set system ntp server time3.vyos.net
        - set system syslog global facility all level 'info'
        - set system syslog global facility protocols level 'debug'
      register: firstout

    - name: print first out
      debug:
        var: firstout.filtered
    - name: change Password for User vyos
      vyos.vyos.vyos_user:
        name: vyos
        configured_password: '{{ vyos_password }}'
        update_password: always
        state: present
    - name: set up firewall zones
      vyos_firewall_global:
        config:
          group:
            address_group:
            - name: proxmox
              afi: ipv4
              description: proxmox-servers
              members:
                - address: 10.2.0.10
                - address: 10.2.0.20
                - address: 10.2.0.22
            - name: pi-dns
              afi: ipv4
              description: pihole addresses
              members:
                - address: 10.2.0.4
            - name: prox-bs
              afi: ipv4
              description: proxmox backup server
              members:
                - address: 10.2.0.11
            - name: arch-vms
              afi: ipv4
              description: arch vms
              members:
                - address: 10.9.9.69-10.9.9.100
                - address: 10.9.9.137-10.9.9.141
                - address: 10.9.10.69-10.9.10.100
            - name: arch-bm
              afi: ipv4
              description: arch bm
              members:
                - address: 10.9.0.69-10.9.0.100
                - address: 10.9.0.137-10.9.0.141
            - name: jellyfin
              afi: ipv4
              description: jellyfin
              members:
                - address: 10.8.8.8
            - name: deluge
              afi: ipv4
              description: deluge
              members:
                - address: 10.8.8.7
            - name: media
              afi: ipv4
              description: deluge
              members:
                - address: 10.8.8.7-10.8.8.8
            - name: pixel5a
              afi: ipv4
              description: pixel 5a
              members:
                - address: 10.4.0.141
            - name: laptop
              afi: ipv4
              description: laptop wifi
              members:
                - address: 10.4.0.137
            - name: hnds-vlan4
              afi: ipv4
              description: my vlan4 range
              members:
                - address: 10.4.0.137-10.4.0.141

            network_group:
            - name: vlan2
              afi: ipv4
              description: vlan2
              members:
                - address: 10.2.0.0/20
            - name: vlan4
              afi: ipv4
              description: vlan4-wlan
              members:
                - address: 10.4.0.0/16
            - name: vlan7
              afi: ipv4
              description: vlan7-cluster network
              members:
                - address: 10.7.0.0/16
            - name: vlan8
              afi: ipv4
              description: vlan8-media
              members:
                - address: 10.8.0.0/16
            - name: vlan9
              afi: ipv4
              description: vlan9-arch vms
              members:
                - address: 10.9.0.0/16
            - name: vlan11
              afi: ipv4
              description: vlan1-win vms
              members:
                - address: 10.11.0.0/16

    - name: set up firewalls for zone based fw
      vyos_firewall_rules:
        config:
        - afi: ipv4
          rule_sets:
            - name: wan-outside-in
              description: wan-outside-in firewall
              default_action: drop
              rules:
                - number: 10
                  action: accept
                  state:
                    established: true
                    related: true

            - name: wan-outside-local
              description: wan-outside-local firewall
              default_action: drop
              rules:
                - number: 10
                  action: accept
                  state:
                    established: true
                    related: true
                - number: 20
                  action: accept
                  icmp:
                    type_name: echo-request
                  protocol: icmp
                  state:
                    new: true



            - name: vlan11-vlan8
              description: vlan11-vlan8
              default_action: drop
              rules:
              - number: 10
                action: accept
                description: media
                destination:
                  group:
                    address_group: media
                source:
                  group:
                    network_group: vlan11
            - name: vlan8-vlan11
              description: vlan8-vlan11
              default_action: drop
              rules:
              - number: 10
                action: accept
                description: media
                destination:
                  group:
                    network_group: vlan11
                source:
                  group:
                    address_group: media

            - name: vlan9-vlan8
              description: vlan9-vlan8
              default_action: drop
              rules:
              - number: 10
                action: accept
                description: media
                destination:
                  group:
                    address_group: media
                source:
                  group:
                    network_group: vlan9

            - name: vlan8-vlan9
              description: vlan8-vlan9 rule set
              default_action: drop
              rules:
              - number: 10
                action: accept
                description: media to vlan9
                destination:
                  group:
                    network_group: vlan9
                source:
                  group:
                    address_group: media
                state:
                  established: true
                  related: true

            - name: vlan9-vlan2
              description: vlan9-vlan2 rule set
              default_action: drop
              rules:
              - number: 10
                action: accept
                description: vlan9-vlan2
                destination:
                  group:
                    network_group: vlan2
                source:
                  group:
                    network_group: vlan9

            - name: vlan2-vlan9
              description: vlan2-vlan9 rule set
              default_action: drop
              rules:
              - number: 10
                action: accept
                description: vlan2-vlan9
                destination:
                  group:
                    network_group: vlan9
                source:
                  group:
                    network_group: vlan2

            - name: vlan9-vlan4
              description: vlan9-vlan4 rule set
              default_action: drop
              rules:
              - number: 10
                action: accept
                description: vlan9-vlan4
                destination:
                  group:
                    network_group: vlan4
                source:
                  group:
                    network_group: vlan9

            - name: vlan4-vlan9
              description: vlan4-vlan9 rule set
              default_action: drop
              rules:
              - number: 20
                action: accept
                description: vlan4-vlan9
                destination:
                  group:
                    network_group: vlan9
                source:
                  group:
                    network_group: vlan4
                state:
                  established: true
                  related: true
              - number: 10
                action: accept
                description: allow personal devices
                destination:
                  group:
                    network_group: vlan9
                source:
                  group:
                    address_group: hnds-vlan4


            - name: vlan9-vlan2
              description: vlan9-vlan2 rule set
              default_action: drop
              rules:
              - number: 10
                action: accept
                description: vlan9-vlan2
                destination:
                  group:
                    network_group: vlan2
                source:
                  group:
                    network_group: vlan9

            - name: vlan2-vlan9
              description: vlan2-vlan9 rule set
              default_action: drop
              rules:
              - number: 10
                action: accept
                description: vlan2-vlan9
                destination:
                  group:
                    network_group: vlan9
                source:
                  group:
                    network_group: vlan2

            - name: vlan4-vlan2
              description: vlan4-vlan2 rule set
              default_action: drop
              rules:
              - number: 10
                action: accept
                description: my wlan to vlan2
                destination:
                  group:
                    network_group: vlan2
                source:
                  group:
                    address_group: hnds-vlan4


            - name: vlan2-vlan4
              description: vlan2-vlan4 rule set
              default_action: drop
              rules:
              - number: 10
                action: accept
                description: vlan2 to my wlan
                destination:
                  group:
                    address_group: hnds-vlan4
                source:
                  group:
                    network_group: vlan2


            - name: vlan2-vlan8
              description: vlan2 to vlan8
              default_action: drop
              rules:
              - number: 10
                action: accept
                destination:
                  group:
                    network_group: vlan8
                source:
                  group:
                    address_group: proxmox

            - name: vlan8-vlan2
              description: vlan8 to vlan2
              default_action: drop
              rules:
              - number: 10
                action: accept
                destination:
                  group:
                    address_group: proxmox
                source:
                  group:
                    address_group: media
                state:
                  established: true
                  related: true

            - name: vlan2-vlan11
              description: vlan2 to vlan11
              default_action: drop
              rules:
              - number: 10
                action: accept
                destination:
                  group:
                    network_group: vlan11
                source:
                  group:
                    address_group: pi-dns

            - name: vlan11-vlan2
              description: vlan11 to vlan2
              default_action: drop
              rules:
              - number: 10
                action: accept
                destination:
                  group:
                    address_group: pi-dns
                source:
                  group:
                    network_group: vlan11

            - name: vlan9-vlan11
              description: vlan9 to vlan11
              default_action: drop
              rules:
              - number: 10
                action: accept
                destination:
                  group:
                    network_group: vlan11
                source:
                  group:
                    network_group: vlan9

            - name: vlan11-vlan9
              description: vlan11 to vlan9
              default_action: drop
              rules:
              - number: 10
                action: accept
                destination:
                  group:
                    network_group: vlan9
                source:
                  group:
                    network_group: vlan11
                state:
                  established: true
                  related: true

            - name: vlan8-vlan4
              description: vlan8 to vlan4
              default_action: drop
              rules:
              - number: 10
                action: accept
                description: media to hnds-vlan4
                destination:
                  group:
                    address_group: hnds-vlan4
                source:
                  group:
                    address_group: media
                state:
                  established: true
                  related: true

            - name: vlan4-vlan8
              description: vlan4 to vlan8
              default_action: drop
              rules:
              - number: 10
                action: accept
                description: hnds-vlan4 to media
                destination:
                  group:
                    address_group: media
                source:
                  group:
                    address_group: hnds-vlan4

            - name: wan-lan
              description: wan - lan
              default_action: drop
              rules:
              - number: 10
                action: accept
                state:
                  established: true
                  related: true
            - name: lan-wan
              description: lan - wan
              default_action: accept
        state: overridden



    - name: set eth0 mac address
      vyos_config:
        lines:
          set interfaces ethernet eth0 hw-id 32:5C:D9:AA:E7:79


    - name: set up interfaces
      vyos_l3_interfaces:
        config:
        - name: eth0
          ipv4:
          - address: dhcp
        - name: eth1
          vifs:
          - vlan_id: 2
            ipv4:
            - address: 10.2.{{ octet3 }}.{{ vyos_id }}/20
          - vlan_id: 4
            ipv4:
            - address: 10.4.{{ octet3 }}.{{ vyos_id }}/24
            - address: 10.4.0.104/24
          - vlan_id: 8
            ipv4:
            - address: 10.8.{{ octet3 }}.{{ vyos_id }}/16
          - vlan_id: 9
            ipv4:
            - address: 10.9.{{ octet3 }}.{{ vyos_id }}/16
          - vlan_id: 11
            ipv4:
            - address: 10.11.{{ octet3 }}.{{ vyos_id }}/16
    - name: set descriptions
      vyos_interfaces:
        config:
        - name: eth0
          description: WAN!!

    - name: set wan firewall
      vyos_config:
        lines:
        - set firewall interface eth0 in name wan-outside-in
        - set firewall interface eth0 local name wan-outside-local
    - name: set vrrp
      vyos_config:
        lines:
        - set high-availability vrrp group vrrp-2 address '10.2.0.5/16'
        - set high-availability vrrp group vrrp-2 interface 'eth1.2'
        - set high-availability vrrp group vrrp-2 rfc3768-compatibility
        - set high-availability vrrp group vrrp-2 vrid '1'
        - set high-availability vrrp group vrrp-2 priority {{ vrrp_priority }}
        - set high-availability vrrp group vrrp-4 address '10.4.0.5/16'
        - set high-availability vrrp group vrrp-4 interface 'eth1.4'
        - set high-availability vrrp group vrrp-4 rfc3768-compatibility
        - set high-availability vrrp group vrrp-4 vrid '1'
        - set high-availability vrrp group vrrp-4 priority {{ vrrp_priority }}
        - set high-availability vrrp group vrrp-8 address '10.8.0.5/16'
        - set high-availability vrrp group vrrp-8 interface 'eth1.8'
        - set high-availability vrrp group vrrp-8 rfc3768-compatibility
        - set high-availability vrrp group vrrp-8 vrid '1'
        - set high-availability vrrp group vrrp-8 priority {{ vrrp_priority }}
        - set high-availability vrrp group vrrp-9 address '10.9.0.5/16'
        - set high-availability vrrp group vrrp-9 interface 'eth1.9'
        - set high-availability vrrp group vrrp-9 rfc3768-compatibility
        - set high-availability vrrp group vrrp-9 vrid '1'
        - set high-availability vrrp group vrrp-9 priority {{ vrrp_priority }}
        - set high-availability vrrp group vrrp-11 address '10.11.0.5/16'
        - set high-availability vrrp group vrrp-11 interface 'eth1.11'
        - set high-availability vrrp group vrrp-11 rfc3768-compatibility
        - set high-availability vrrp group vrrp-11 vrid '1'
        - set high-availability vrrp group vrrp-11 priority {{ vrrp_priority }}

    - name: set zone based fw
      vyos_config:
        lines:
        - set firewall zone WAN default-action 'drop'
        - set firewall zone WAN interface 'eth0'
        - set firewall zone WAN from vlan2 firewall name 'lan-wan'
        - set firewall zone WAN from vlan4 firewall name 'lan-wan'
        - set firewall zone WAN from vlan8 firewall name 'lan-wan'
        - set firewall zone WAN from vlan9 firewall name 'lan-wan'
        - set firewall zone WAN from vlan11 firewall name 'lan-wan'

        - set firewall zone vlan9 default-action 'drop'
        - set firewall zone vlan9 from WAN firewall name 'wan-lan'
        - set firewall zone vlan9 from vlan8 firewall name 'vlan8-vlan9'
        - set firewall zone vlan9 from vlan2 firewall name 'vlan2-vlan9'
        - set firewall zone vlan9 from vlan4 firewall name 'vlan4-vlan9'
        - set firewall zone vlan9 from vlan11 firewall name 'vlan11-vlan9'
        - set firewall zone vlan9 interface 'eth1.9v1v4'
        - set firewall zone vlan9 interface 'eth1.9'

        - set firewall zone vlan8 default-action 'drop'
        - set firewall zone vlan8 description 'media-server'
        - set firewall zone vlan8 from WAN firewall name 'wan-lan'
        - set firewall zone vlan8 from vlan9 firewall name 'vlan9-vlan8'
        - set firewall zone vlan8 from vlan2 firewall name 'vlan2-vlan8'
        - set firewall zone vlan8 from vlan4 firewall name 'vlan4-vlan8'
        - set firewall zone vlan8 from vlan11 firewall name 'vlan11-vlan8'
        - set firewall zone vlan8 interface 'eth1.8v1v4'
        - set firewall zone vlan8 interface 'eth1.8'

        - set firewall zone vlan2 default-action 'drop'
        - set firewall zone vlan2 from WAN firewall name 'wan-lan'
        - set firewall zone vlan2 from vlan9 firewall name 'vlan9-vlan2'
        - set firewall zone vlan2 from vlan8 firewall name 'vlan8-vlan2'
        - set firewall zone vlan2 from vlan11 firewall name 'vlan11-vlan2'
        - set firewall zone vlan2 from vlan4 firewall name 'vlan4-vlan2'
        - set firewall zone vlan2 interface 'eth1.2'
        - set firewall zone vlan2 interface 'eth1.2v1v4'

        - set firewall zone vlan11 default-action 'drop'
        - set firewall zone vlan11 from WAN firewall name 'wan-lan'
        - set firewall zone vlan11 from vlan2 firewall name 'vlan2-vlan11'
        - set firewall zone vlan11 from vlan8 firewall name 'vlan8-vlan11'
        - set firewall zone vlan11 interface 'eth1.11'
        - set firewall zone vlan11 interface 'eth1.11v1v4'

        - set firewall zone vlan4 default-action 'drop'
        - set firewall zone vlan4 from WAN firewall name 'wan-lan'
        - set firewall zone vlan4 from vlan9 firewall name 'vlan9-vlan4'
        - set firewall zone vlan4 from vlan8 firewall name 'vlan8-vlan4'
        - set firewall zone vlan4 from vlan2 firewall name 'vlan2-vlan4'
        - set firewall zone vlan4 interface 'eth1.4v1v4'
        - set firewall zone vlan4 interface 'eth1.4'

    - name: configure nat
      vyos_config:
        lines:
        - set nat source rule 100 outbound-interface 'eth0'
        - set nat source rule 100 source address '10.9.0.0/16'
        - set nat source rule 100 translation address 'masquerade'
        - set nat source rule 101 outbound-interface 'eth0'
        - set nat source rule 101 source address '10.2.0.0/16'
        - set nat source rule 101 translation address 'masquerade'
        - set nat source rule 102 outbound-interface 'eth0'
        - set nat source rule 102 source address '10.4.0.0/16'
        - set nat source rule 102 translation address 'masquerade'
        - set nat source rule 103 outbound-interface 'eth0'
        - set nat source rule 103 source address '10.11.0.0/16'
        - set nat source rule 103 translation address 'masquerade'
        - set nat source rule 108 outbound-interface 'eth0'
        - set nat source rule 108 source address '10.8.0.0/16'
        - set nat source rule 108 translation address 'masquerade'
          #    - name: delete cloud interface
          #      vyos_config:
          #        lines:
          #        - delete interfaces ethernet eth2
#   - name: configure dns
#     vyos_config:
#       lines:
#       - set service dns forwarding name-server 10.2.0.4
#       - set service dns forwarding allow-from 10.2.0.0/20
#       - set service dns forwarding allow-from 10.4.0.0/24
#       - set service dns forwarding allow-from 10.8.0.0/16
#       - set service dns forwarding allow-from 10.9.0.0/16
#       - set service dns forwarding allow-from 10.11.0.0/16
#       - set service dns forwarding listen-address 10.2.0.5
